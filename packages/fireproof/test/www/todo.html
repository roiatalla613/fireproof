<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fireproof Test</title>
    <script src="../../dist/browser/fireproof.iife.js?935"></script>
    <script type="text/javascript">
      function todoApp() {
        const {connect, fireproof, index} = Fireproof;
        let dbName
        let db
        let connection

        function setupDb(name) {
          dbName = name;
          db = fireproof(name);
          window.db = db;
          connection = connect.s3(db, s3Info)
          db.subscribe(redraw);
          return db;
        }
        const s3Info = {
          upload: 'https://04rvvth2b4.execute-api.us-east-2.amazonaws.com/uploads',
          download: 'https://sam-app-s3uploadbucket-e6rv1dj2kydh.s3.us-east-2.amazonaws.com'
        }

        const redraw = async () => {
          try {
            const result = await index(db, 'created').query({includeDocs: true});
            document
              .querySelector('ul')
              .innerHTML = '';

            for (const row of result.rows) {
              const checkbox = document.createElement('input');
              checkbox.setAttribute('type', 'checkbox');
              if (row.doc.completed) {
                checkbox.setAttribute('checked', true);
              }
              checkbox.onchange = () => {
                row.doc.completed = !row
                  .doc
                  .completed
                  db
                  .put(row.doc);
              }
              const textSpan = document.createElement('span');
              textSpan.innerText = row.doc.task;
              const li = document.createElement('li');
              li.appendChild(checkbox);
              li.appendChild(textSpan);
              document
                .querySelector('ul')
                .appendChild(li);
            }
          } finally {
            const chgs = await db.changes([], {dirty: true});
            console.log('changes', chgs.rows.map(r => r.value.task), chgs)
          }
        }

        async function initialize() {
          ps = new URLSearchParams(location.search)
          const listQ = ps.get('list')
          setupDb(listQ || 'my-list');
          const input = document.querySelector('#list');
          input.value = dbName;
          redraw()
        }

        async function changeList(e) {
          e.preventDefault();
          const input = document.querySelector('#list');
          dbName = input.value;
          history.pushState(null, '', location.pathname + '?list=' + encodeURIComponent(dbName));
          setupDb(dbName);

          redraw();
        }
        window.changeList = changeList;

        async function onButtonClick(e) {
          e.preventDefault();
          connection
            .refresh()
            .then(() => console.log('refreshed'))
          const input = document.querySelector('#todo');
          const ok = await db.put({created: Date.now(), task: input.value, completed: false});
          input.value = '';

        }
        window.onButtonClick = onButtonClick;

        async function connectionRefresh(e) {
          e.preventDefault();
          await connection.refresh()
        }
        window.connectionRefresh = connectionRefresh;

        window.onload = initialize;
        window.db = db;
        window.redraw = redraw;
      }
      todoApp();
    </script>
  </head>
  <body>
    <h1>Fireproof Todos</h1>
    List:
    <input type="text" name="list" id="list"/>
    <button onclick="changeList(event)">Change List</button>
    <h3>Todos</h3>
    <input type="text" name="todo" id="todo"/>
    <button onclick="onButtonClick(event)">Create Todo</button>
    <button onclick="connectionRefresh(event)">Refresh</button>
    <ul></ul>
  </body>
</html>
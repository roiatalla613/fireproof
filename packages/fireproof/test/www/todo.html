<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fireproof Test</title>
    <script src="../../dist/browser/fireproof.iife.js?935"></script>
    <script type="text/javascript">
      function todoApp() {
        const {connect, fireproof, index} = Fireproof;

        const db = fireproof('todo-app-fps');
        const connection = connect.s3(db, {
          upload: 'https://04rvvth2b4.execute-api.us-east-2.amazonaws.com/uploads',
          download: 'https://sam-app-s3uploadbucket-e6rv1dj2kydh.s3.us-east-2.amazonaws.com'
        })

        const redraw = async () => {
          const result = await index(db, 'created').query({includeDocs: true});
          document
            .querySelector('ul')
            .innerHTML = '';

          for (const row of result.rows) {
            const checkbox = document.createElement('input');
            checkbox.setAttribute('type', 'checkbox');
            if (row.doc.completed) {
              checkbox.setAttribute('checked', true);
            }
            checkbox.onchange = () => {
              row.doc.completed = !row
                .doc
                .completed
                db
                .put(row.doc);
            }
            const textSpan = document.createElement('span');
            textSpan.innerText = row.doc.task;
            const li = document.createElement('li');
            li.appendChild(checkbox);
            li.appendChild(textSpan);
            document
              .querySelector('ul')
              .appendChild(li);
          }

          const chgs = await db.changes();
          console.log('changes', chgs.rows.map(r => r.value.task))

        }

        async function initialize() {
          db.subscribe(redraw);
          redraw()
        }

        async function onButtonClick(e) {
          e.preventDefault();
          const input = document.querySelector('#todo');
          const ok = await db.put({created: Date.now(), task: input.value, completed: false});
          input.value = '';
        }
        window.onButtonClick = onButtonClick;
        window.onload = initialize;
        window.db = db;
        window.redraw = redraw;
      }
      todoApp();
    </script>
  </head>
  <body>
    <h1>Fireproof Todos</h1>
    <input type="text" name="todo" id="todo"/>
    <button onclick="onButtonClick(event)">Create Todo</button>
    <ul></ul>
  </body>
</html>